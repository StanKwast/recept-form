<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Submit a Recipe</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
      background: #fafafa;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    form {
      background: white;
      padding: 1.5rem;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 0.4rem 0.6rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    button[type="submit"] {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    button[type="submit"]:hover {
      background-color: #45a049;
    }
    #categorySuggestions {
      margin-bottom: 1rem;
    }
    #categorySuggestions button {
      background: #ddd;
      border: none;
      border-radius: 3px;
      padding: 0.2rem 0.5rem;
      margin: 0 0.25rem 0.25rem 0;
      cursor: pointer;
      font-size: 0.9rem;
    }
    #categorySuggestions button:hover {
      background: #ccc;
    }
    #status {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Recipe Submission Form</h1>
  <form id="recipeForm">
    <label>Title: <input type="text" name="title" required></label>

    <label>Categories (add multiple separated by commas or click buttons below):</label>
    <input type="text" id="categoryInput" name="categoryInput" placeholder="e.g. breakfast, vegan" autocomplete="off" />
    <div id="categorySuggestions" aria-label="Category suggestions"></div>

    <label>Ingredients:<br>
      <textarea name="ingredients" rows="5" required placeholder="List ingredients, one per line"></textarea>
    </label>

    <label>Instructions:<br>
      <textarea name="instructions" rows="5" required placeholder="Step-by-step instructions"></textarea>
    </label>

    <button type="submit">Submit Recipe</button>
  </form>

  <p id="status"></p>

  <script>
    // Fetch existing categories from GitHub repo /recipes folder
    async function fetchExistingCategories() {
      try {
        const res = await fetch("https://api.github.com/repos/StanKwast/koken/contents/recipes");
        if (!res.ok) return [];
        const files = await res.json();

        const categoriesSet = new Set();

        await Promise.all(files.map(async (file) => {
          if (!file.name.endsWith(".json")) return;
          const recipeRes = await fetch(file.download_url);
          if (!recipeRes.ok) return;
          const recipe = await recipeRes.json();
          if (recipe.category) {
            if (Array.isArray(recipe.category)) {
              recipe.category.forEach(cat => categoriesSet.add(cat.trim()));
            } else {
              categoriesSet.add(recipe.category.trim());
            }
          }
        }));

        return Array.from(categoriesSet).sort();
      } catch {
        return [];
      }
    }

    // Display category suggestion buttons
    function showCategorySuggestions(categories) {
      const suggestionsDiv = document.getElementById("categorySuggestions");
      suggestionsDiv.innerHTML = "";
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = cat;
        btn.onclick = () => addCategory(cat);
        suggestionsDiv.appendChild(btn);
      });
    }

    // Add category to input, avoiding duplicates
    function addCategory(category) {
      const input = document.getElementById("categoryInput");
      let current = input.value.split(",").map(s => s.trim()).filter(Boolean);
      if (!current.includes(category)) {
        current.push(category);
        input.value = current.join(", ");
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      const categories = await fetchExistingCategories();
      showCategorySuggestions(categories);
    });

    // Handle form submission
    document.getElementById("recipeForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const categories = formData.get("categoryInput").split(",").map(s => s.trim()).filter(Boolean);

      const recipe = {
        title: formData.get("title").trim(),
        category: categories,
        ingredients: formData.get("ingredients").trim().split("\n").map(s => s.trim()).filter(Boolean),
        instructions: formData.get("instructions").trim().split("\n").map(s => s.trim()).filter(Boolean),
        timestamp: new Date().toISOString()
      };

      const filename = recipe.title.toLowerCase().replace(/\s+/g, "_") + "_" + Date.now() + ".json";

      const status = document.getElementById("status");
      status.textContent = "Submitting...";

      try {
        const response = await fetch("https://recept-form.vercel.app/api/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename, recipe })
        });

        if (response.ok) {
          status.textContent = "Recipe submitted successfully!";
          e.target.reset();
        } else {
          const error = await response.json();
          status.textContent = "Error: " + (error?.message || "Unknown error.");
        }
      } catch (err) {
        status.textContent = "Network error: " + err.message;
      }
    });
  </script>
</body>
</html>
